package tesis.image_description_app.network

import com.squareup.moshi.Moshi
import com.squareup.moshi.kotlin.reflect.KotlinJsonAdapterFactory
import tesis.image_description_app.data.imageDescription.request.ImageDescriptionBodyRequest
import tesis.image_description_app.data.imageDescription.request.Message

class ImageDescriptionRepository(private val chatGptApiService: ChatGptApiService) {

    suspend fun getImageDescription(): Result<String> {

        val temperature = 0.2
        val system_message = Message( "system", "Voy a compartir un conjunto de datos en formato JSON que contiene información sobre una imagen en particular. Mi objetivo es que puedas crear una descripción coherente y comprensible de la imagen, de manera que cualquier persona que lea tu respuesta pueda entender de qué se trata la imagen sin necesidad de verla.  No incluyas detalles técnicos, como términos relacionados con API, JSON o procesos de puntuación de modelos de IA en tu respuesta. Por favor, utiliza los atributos \"labelAnnotations\" para interpretar la imagen y mejorar la calidad del texto. Por favor, para interpretar la imagen, el atributo 'localizedObjectAnnotations' debe tener prioridad para interpretar de qué se trata la imagen.")
        val user_message = Message("user", "{'responses':[{'logoAnnotations':[{'mid':'/m/03fjbd','description':'FCWITGeorgia','score':0.60066235,'boundingPoly':{'vertices':[{'x':164,'y':963},{'x':322,'y':963},{'x':322,'y':1126},{'x':164,'y':1126}]}}],'labelAnnotations':[{'mid':'/m/02h00q','description':'Jersey','score':0.8800713,'topicality':0.8800713},{'mid':'/m/062581','description':'Sleeve','score':0.8724504,'topicality':0.8724504},{'mid':'/m/0n49352','description':'Sportsgear','score':0.84421736,'topicality':0.84421736},{'mid':'/m/025xryy','description':'Sportswear','score':0.8218265,'topicality':0.8218265},{'mid':'/m/01vm1p','description':'Elbow','score':0.7893558,'topicality':0.7893558},{'mid':'/m/0n5v01m','description':'Bag','score':0.7852081,'topicality':0.7852081},{'mid':'/m/031974','description':'Waist','score':0.76462585,'topicality':0.76462585},{'mid':'/m/0ffjr','description':'Personalprotectiveequipment','score':0.75444263,'topicality':0.75444263},{'mid':'/m/08xgn7','description':'Comfort','score':0.7414647,'topicality':0.7414647},{'mid':'/m/0dzdr','description':'Chest','score':0.74046713,'topicality':0.74046713}],'textAnnotations':[{'locale':'en','description':''ma&SAY11','boundingPoly':{'vertices':[{'x':190,'y':874},{'x':547,'y':874},{'x':547,'y':1095},{'x':190,'y':1095}]}},{'description':''','boundingPoly':{'vertices':[{'x':548,'y':874},{'x':548,'y':951},{'x':505,'y':951},{'x':505,'y':874}]}},{'description':'ma','boundingPoly':{'vertices':[{'x':246,'y':995},{'x':215,'y':1035},{'x':200,'y':1022},{'x':230,'y':983}]}},{'description':'&','boundingPoly':{'vertices':[{'x':237,'y':1015},{'x':241,'y':1019},{'x':237,'y':1023},{'x':233,'y':1019}]}},{'description':'SAY','boundingPoly':{'vertices':[{'x':231,'y':1020},{'x':236,'y':1025},{'x':218,'y':1041},{'x':213,'y':1036}]}},{'description':'11','boundingPoly':{'vertices':[{'x':306,'y':1042},{'x':220,'y':1095},{'x':192,'y':1050},{'x':277,'y':996}]}}],'safeSearchAnnotation':{'adult':'POSSIBLE','spoof':'UNLIKELY','medical':'UNLIKELY','violence':'UNLIKELY','racy':'POSSIBLE'},'imagePropertiesAnnotation':{'dominantColors':{'colors':[{'color':{'red':60,'green':49,'blue':48},'score':0.19728953,'pixelFraction':0.21063492},{'color':{'red':191,'green':200,'blue':195},'score':0.14346443,'pixelFraction':0.10587302},{'color':{'red':89,'green':75,'blue':75},'score':0.15613087,'pixelFraction':0.099603176},{'color':{'red':32,'green':23,'blue':22},'score':0.15442705,'pixelFraction':0.2557143},{'color':{'red':71,'green':51,'blue':53},'score':0.15288685,'pixelFraction':0.041825395},{'color':{'red':88,'green':67,'blue':70},'score':0.07757944,'pixelFraction':0.027619047},{'color':{'red':157,'green':161,'blue':156},'score':0.03272206,'pixelFraction':0.045079365},{'color':{'red':217,'green':224,'blue':220},'score':0.026474074,'pixelFraction':0.093650796},{'color':{'red':119,'green':116,'blue':112},'score':0.023139741,'pixelFraction':0.02563492},{'color':{'red':44,'green':24,'blue':26},'score':0.020900996,'pixelFraction':0.008968254}]}},'cropHintsAnnotation':{'cropHints':[{'boundingPoly':{'vertices':[{'y':369},{'x':719,'y':369},{'x':719,'y':910},{'y':910}]},'confidence':0.59375,'importanceFraction':0.8458648}]},'fullTextAnnotation':{'pages':[{'property':{'detectedLanguages':[{'languageCode':'en','confidence':0.58549064}]},'width':720,'height':1280,'blocks':[{'boundingBox':{'vertices':[{'x':548,'y':874},{'x':548,'y':951},{'x':505,'y':951},{'x':505,'y':874}]},'paragraphs':[{'boundingBox':{'vertices':[{'x':548,'y':874},{'x':548,'y':951},{'x':505,'y':951},{'x':505,'y':874}]},'words':[{'boundingBox':{'vertices':[{'x':548,'y':874},{'x':548,'y':951},{'x':505,'y':951},{'x':505,'y':874}]},'symbols':[{'property':{'detectedBreak':{'type':'LINE_BREAK'}},'boundingBox':{'vertices':[{'x':548,'y':874},{'x':548,'y':951},{'x':505,'y':951},{'x':505,'y':874}]},'text':''','confidence':0.16680832}],'confidence':0.16680832}],'confidence':0.16680832}],'blockType':'TEXT','confidence':0.16680832},{'boundingBox':{'vertices':[{'x':246,'y':995},{'x':215,'y':1035},{'x':200,'y':1022},{'x':230,'y':983}]},'paragraphs':[{'boundingBox':{'vertices':[{'x':246,'y':995},{'x':215,'y':1035},{'x':200,'y':1022},{'x':230,'y':983}]},'words':[{'boundingBox':{'vertices':[{'x':246,'y':995},{'x':215,'y':1035},{'x':200,'y':1022},{'x':230,'y':983}]},'symbols':[{'boundingBox':{'vertices':[{'x':245,'y':996},{'x':230,'y':1012},{'x':217,'y':1000},{'x':232,'y':984}]},'text':'m','confidence':0.11743128},{'property':{'detectedBreak':{'type':'LINE_BREAK'}},'boundingBox':{'vertices':[{'x':223,'y':1021},{'x':215,'y':1033},{'x':200,'y':1023},{'x':208,'y':1011}]},'text':'a','confidence':0.10668462}],'confidence':0.112057954}],'confidence':0.112057954}],'blockType':'TEXT','confidence':0.112057954},{'boundingBox':{'vertices':[{'x':237,'y':1015},{'x':242,'y':1020},{'x':218,'y':1042},{'x':213,'y':1037}]},'paragraphs':[{'boundingBox':{'vertices':[{'x':237,'y':1015},{'x':242,'y':1020},{'x':218,'y':1042},{'x':213,'y':1037}]},'words':[{'property':{'detectedLanguages':[{'languageCode':'en','confidence':1}]},'boundingBox':{'vertices':[{'x':237,'y':1015},{'x':241,'y':1019},{'x':237,'y':1023},{'x':233,'y':1019}]},'symbols':[{'property':{'detectedBreak':{'type':'SPACE'}},'boundingBox':{'vertices':[{'x':237,'y':1015},{'x':241,'y':1019},{'x':237,'y':1023},{'x':233,'y':1019}]},'text':'&','confidence':0.54598397}],'confidence':0.54598397},{'property':{'detectedLanguages':[{'languageCode':'en','confidence':1}]},'boundingBox':{'vertices':[{'x':231,'y':1020},{'x':236,'y':1025},{'x':218,'y':1041},{'x':213,'y':1036}]},'symbols':[{'boundingBox':{'vertices':[{'x':231,'y':1020},{'x':235,'y':1024},{'x':230,'y':1029},{'x':226,'y':1025}]},'text':'S','confidence':0.3965701},{'boundingBox':{'vertices':[{'x':226,'y':1025},{'x':230,'y':1029},{'x':226,'y':1033},{'x':222,'y':1029}]},'text':'A','confidence':0.4309466},{'property':{'detectedBreak':{'type':'LINE_BREAK'}},'boundingBox':{'vertices':[{'x':219,'y':1032},{'x':223,'y':1036},{'x':218,'y':1041},{'x':214,'y':1037}]},'text':'Y','confidence':0.32697642}],'confidence':0.38483104}],'confidence':0.42511928}],'blockType':'TEXT','confidence':0.42511928},{'boundingBox':{'vertices':[{'x':306,'y':1042},{'x':220,'y':1095},{'x':192,'y':1050},{'x':277,'y':996}]},'paragraphs':[{'boundingBox':{'vertices':[{'x':306,'y':1042},{'x':220,'y':1095},{'x':192,'y':1050},{'x':277,'y':996}]},'words':[{'boundingBox':{'vertices':[{'x':306,'y':1042},{'x':220,'y':1095},{'x':192,'y':1050},{'x':277,'y':996}]},'symbols':[{'boundingBox':{'vertices':[{'x':306,'y':1042},{'x':244,'y':1081},{'x':215,'y':1035},{'x':277,'y':996}]},'text':'1','confidence':0.37279245},{'property':{'detectedBreak':{'type':'LINE_BREAK'}},'boundingBox':{'vertices':[{'x':277,'y':1060},{'x':220,'y':1095},{'x':192,'y':1050},{'x':248,'y':1014}]},'text':'1','confidence':0.44016886}],'confidence':0.40648067}],'confidence':0.40648067}],'blockType':'TEXT','confidence':0.40648067}],'confidence':0.27761656}],'text':''ma&SAY11'},'webDetection':{'webEntities':[{'entityId':'/g/11sy1m879z','score':0.6351,'description':'protective'},{'entityId':'/m/0ffjr','score':0.5766069,'description':'Personalprotectiveequipment'},{'entityId':'/m/0n49352','score':0.5636132,'description':'Protectivegearinsports'},{'entityId':'/t/29syjjvbyn_rl','score':0.401},{'entityId':'/g/11fljpmxv','score':0.387,'description':'personal'},{'entityId':'/m/0dnr7','score':0.35533795,'description':'Textile'},{'entityId':'/g/1232v3zw','score':0.3505,'description':'Equipment'},{'entityId':'/m/0x27zdc','score':0.044535,'description':'BlackM'},{'entityId':'/m/01z02hx','description':'Sports'}],'visuallySimilarImages':[{'url':'https://media.karousell.com/media/photos/products/2021/11/1/vans_old_skool_black_mono_1635777728_7720a4b4_progressive.jpg'},{'url':'https://images.tokopedia.net/img/cache/700/VqbcmM/2020/11/25/5755c842-0f41-4826-84e4-3da609ddf378.jpg'},{'url':'https://www.latercera.com/resizer/5zI1lz589hP7vlwIqPOltnRJ7aA=/380x570/filters:focal(654x211:664x201)/cloudfront-us-east-1.images.arcpublishing.com/copesa/UAT4ZUH2SJBGLNWU547ZCQPPZ4.jpg'},{'url':'https://i.ebayimg.com/images/g/gtEAAOSwY~FhcTJH/s-l400.jpg'},{'url':'https://gumtreeau-res.cloudinary.com/image/private/t__35/gumtree/bb2e7557-651e-4d83-9d30-551a22297795.jpg'},{'url':'https://img.kleinanzeigen.de/api/v1/prod-ads/images/79/797f072a-75d2-4541-9060-74b8781b1c2d?rule=_59.JPG'},{'url':'https://i.ytimg.com/vi/QtCfijDuDrY/oar2.jpg?sqp=-oaymwEVCJUDENAFSFryq4qpAwcIARUAAIhC&rs=AOn4CLDC4DVE5jeDfeEZD-ZCswU1hcsKgQ'},{'url':'https://pbs.twimg.com/profile_images/1610793980207288323/fatg1VTF_400x400.jpg'},{'url':'https://preview.redd.it/do-you-use-gloves-if-so-what-kind-v0-1pfdegsteh7b1.jpg?width=640&crop=smart&auto=webp&s=4447ace3a0cf2901ec96d4d689dca8a17a85f6f5'},{'url':'https://static.mercdn.net/item/detail/orig/photos/m44191559557_1.jpg'}],'bestGuessLabels':[{'label':'protectivegearinsports'}]},'localizedObjectAnnotations':[{'mid':'/m/01bfm9','name':'Shorts','score':0.8980463,'boundingPoly':{'normalizedVertices':[{'x':0.0018112456,'y':0.19384891},{'x':0.7857185,'y':0.19384891},{'x':0.7857185,'y':0.92709047},{'x':0.0018112456,'y':0.92709047}]}}]}]}\"")
        val messages = listOf(system_message, user_message)
        val model = "gpt-3.5-turbo"
        val chatgptBodyRequest = ImageDescriptionBodyRequest(messages, model, temperature)

        //Prueba para ver el json serializado
        val moshi = Moshi.Builder()
            .add(KotlinJsonAdapterFactory())
            .build()
        val adapter = moshi.adapter(ImageDescriptionBodyRequest::class.java)
        val json = adapter.toJson(chatgptBodyRequest)
        println(json)


        return try {
            val response = chatGptApiService.getImageDescription(chatgptBodyRequest)
            println(response)
            val imageInfo = response.choices.first().message.content
            Result.success(imageInfo)
        }
        catch (exception: Exception) {
            Result.failure(exception)
        }
    }

}